/*
** teste_cursor_utf16.ctec - Prova o bug UTF-16 vs UTF-8 em lsp_get_cursor_context
**
** Comportamento esperado:
** - VS Code envia position.character em UTF-16 code units
** - Servidor deve avançar corretamente e extrair o prefixo sob o cursor
**
** Bug: servidor avança byte-a-byte, então com "função" antes do cursor,
**       ele para 2 bytes antes e extrai prefixo errado.
*/

#Defina teste_cursor_utf16_c
#Defina SOL_LIB
#Defina LSP_TEST_MODE

#Inclua "prefix.int"
#Inclua <stdio.h>
#Inclua <stdlib.h>
#Inclua <string.h>
#Inclua "sol.int"

/* Macros para evitar conflito com libsol.a */
#Defina lsp_main test_lsp_main
#Defina lsp_init test_lsp_init
#Defina lsp_shutdown test_lsp_shutdown
#Defina lsp_get_cursor_context test_lsp_get_cursor_context
#Defina lsp_add_document test_lsp_add_document
#Defina lsp_strdup test_lsp_strdup

#Inclua "../../lsplib.ctec"

#Defina TESTE_OK 0
#Defina TESTE_FALHA 1

Fixo Caractere ultimo_erro[512] = "";

Fixo Vazio registra_erro(Imutável Caractere *fmt, ...) {
    va_list args;
    va_start(args, fmt);
    vsnprintf(ultimo_erro, 512, fmt, args);
    va_end(args);
}

Fixo Vazio imprime(Imutável Caractere *nome, Imutável Caractere *cenario, Inteiro ok) {
    fprintf(stderr, "[%s][%s] %s%s\n", nome, cenario, ok ? "OK" : "FALHA", ok ? "" : ultimo_erro);
}

/* ============================================================
** TESTE: cursor com multibyte UTF-8 antes (função)
** ============================================================ */

Inteiro teste_cursor_utf16_esperado() {
    sol_State *L = solL_newstate();
    LSPState *lsp = lsp_init(L);

    /* Linha: "  retorne \"função\" + pr"
       - 2 espaços = 2
       - 'retorne' = 7 -> 9
       - espaço = 1 -> 10
       - '"' = 1 -> 11
       - 'função' (6 UTF-16 units) -> 17
       - '"' = 1 -> 18
       - espaço = 1 -> 19
       - '+' = 1 -> 20
       - espaço = 1 -> 21
       - 'pr' = 2 -> 23
       Cursor no final de 'pr' -> character = 23 (UTF-16)
    */
    Imutável Caractere *codigo = "  retorne \"função\" + pr\n";
    LSPDocument *doc = lsp_add_document(lsp, "file:///utf16.sol", codigo);

    Caractere word[256], table[64];
    Inteiro isDot = 0;
    lsp_get_cursor_context(doc, 0, 23, word, 256, &isDot, table, 64);

    Inteiro ok = 1;
    Se (strcmp(word, "pr") != 0) {
        registra_erro("word='%s' esperava 'pr'", word);
        ok = 0;
    }
    Se (isDot) {
        registra_erro("isDot=%d esperava 0", isDot);
        ok = 0;
    }

    lsp_shutdown(lsp);
    sol_close(L);
    Retorne ok ? TESTE_OK : TESTE_FALHA;
}

/* ============================================================
** TESTE: cursor no início da linha (underflow)
** ============================================================ */

Inteiro teste_cursor_utf16_nulo() {
    sol_State *L = solL_newstate();
    LSPState *lsp = lsp_init(L);

    Imutável Caractere *codigo = "função abc\n";
    LSPDocument *doc = lsp_add_document(lsp, "file:///null.sol", codigo);

    Caractere word[256], table[64];
    Inteiro isDot = 0;
    /* Cursor no início da linha: character = 0 */
    lsp_get_cursor_context(doc, 0, 0, word, 256, &isDot, table, 64);

    /* Não deve crashar; word deve estar vazio */
    Inteiro ok = 1;
    Se (strlen(word) != 0) {
        registra_erro("word='%s' esperava ''", word);
        ok = 0;
    }
    Se (isDot) {
        registra_erro("isDot=%d esperava 0", isDot);
        ok = 0;
    }

    lsp_shutdown(lsp);
    sol_close(L);
    Retorne ok ? TESTE_OK : TESTE_FALHA;
}

/* ============================================================
** TESTE: cursor após multibyte sem prefixo
** ============================================================ */

Inteiro teste_cursor_utf16_nao_esperado() {
    sol_State *L = solL_newstate();
    LSPState *lsp = lsp_init(L);

    Imutável Caractere *codigo = "  retorne \"função\"\n";
    LSPDocument *doc = lsp_add_document(lsp, "file:///nao.sol", codigo);

    Caractere word[256], table[64];
    Inteiro isDot = 0;
    /* Cursor no final da linha: character = 19 (após aspas) */
    lsp_get_cursor_context(doc, 0, 19, word, 256, &isDot, table, 64);

    /* Não deve extrair palavra (não há identificador sob cursor) */
    Inteiro ok = 1;
    Se (strlen(word) != 0) {
        registra_erro("word='%s' esperava ''", word);
        ok = 0;
    }
    Se (isDot) {
        registra_erro("isDot=%d esperava 0", isDot);
        ok = 0;
    }

    lsp_shutdown(lsp);
    sol_close(L);
    Retorne ok ? TESTE_OK : TESTE_FALHA;
}

/* ============================================================
** TESTE: linha gigante com muitos multibyte (estouro)
** ============================================================ */

Inteiro teste_cursor_utf16_estouro() {
    sol_State *L = solL_newstate();
    LSPState *lsp = lsp_init(L);

    Caractere *linha = (Caractere*)malloc(10000);
    strcpy(linha, "  retorne \"");
    Para (Inteiro i = 0; i < 500; i++) strcat(linha, "função");
    strcat(linha, "\" + pr\n");

    LSPDocument *doc = lsp_add_document(lsp, "file:///estouro.sol", linha);
    free(linha);

    Caractere word[256], table[64];
    Inteiro isDot = 0;
    /* Cursor muito além: character = 50000 */
    lsp_get_cursor_context(doc, 0, 50000, word, 256, &isDot, table, 64);

    /* Não deve crashar; pode extrair 'pr' ou vazio, mas não crashar */
    Inteiro ok = 1;
    /* Apenas verifica que não crashou e que word é razoável */
    Se (strlen(word) > 100) {
        registra_erro("word muito grande: '%s'", word);
        ok = 0;
    }

    lsp_shutdown(lsp);
    sol_close(L);
    Retorne ok ? TESTE_OK : TESTE_FALHA;
}

/* ============================================================
** MAIN
** ============================================================ */

Inteiro Início() {
    fprintf(stderr, "=== TESTE CURSOR UTF-16 vs UTF-8 ===\n");
    Inteiro ok = 0;

    #Defina EXEC(n, c, f) Se(f()==TESTE_OK) { imprime(n,c,1); } Senão { ok=1; imprime(n,c,0); }

    EXEC("cursor_utf16", "ESPERADO", teste_cursor_utf16_esperado);
    EXEC("cursor_utf16", "NULO", teste_cursor_utf16_nulo);
    EXEC("cursor_utf16", "NAO_ESPERADO", teste_cursor_utf16_nao_esperado);
    EXEC("cursor_utf16", "ESTOURO", teste_cursor_utf16_estouro);

    fprintf(stderr, "\n=== RESULTADO: %s ===\n", ok ? "FALHA" : "SUCESSO TOTAL");
    Retorne ok;
}
